<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Management - LMS Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #f56565;
            --dark: #1a202c;
            --light-bg: #f7fafc;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container-custom {
            padding: 30px 15px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .nav-tabs {
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #718096;
            font-weight: 600;
            padding: 15px 25px;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--primary);
            border-color: transparent;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: transparent;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .section-title span {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .btn-add {
            background: linear-gradient(135deg, var(--success) 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.3);
            color: white;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead {
            background: var(--light-bg);
        }
        
        .table thead th {
            border: none;
            color: #4a5568;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 15px;
        }
        
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .btn-sm-action {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            border: none;
            transition: all 0.3s;
            margin-right: 5px;
        }
        
        .btn-edit {
            background: var(--primary);
            color: white;
        }
        
        .btn-edit:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            color: white;
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px 25px;
        }
        
        .modal-title {
            font-weight: 700;
        }
        
        .form-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .empty-state {
            padding: 60px 20px;
            color: #a0aec0;
            font-size: 1.1rem;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .btn-close-white {
            filter: brightness(0) invert(1);
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .header-bar {
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .header-bar h1 {
            margin: 0;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .btn-back {
            background: var(--light-bg);
            color: var(--dark);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .btn-back:hover {
            background: #e2e8f0;
            color: var(--dark);
        }
    </style>
</head>
<body>
    <div class="container-custom">
        <div class="header-bar">
            <h1><i class="fas fa-cogs"></i> System Management</h1>
            <a href="/admin/dashboard" class="btn-back">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
        
        <div class="card">
            <div class="card-body p-0">
                <ul class="nav nav-tabs px-4 pt-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#departments">
                            <i class="fas fa-building"></i> Departments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#classes">
                            <i class="fas fa-graduation-cap"></i> Classes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#groups">
                            <i class="fas fa-users"></i> Groups
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#students">
                            <i class="fas fa-user-graduate"></i> Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#teachers">
                            <i class="fas fa-chalkboard-teacher"></i> Teachers
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content p-4">
                    <!-- Departments Tab -->
                    <div class="tab-pane fade show active" id="departments">
                        <div class="section">
                            <div class="section-title">
                                <span>Departments</span>
                                <button class="btn-add" onclick="showAddDepartmentModal()">
                                    <i class="fas fa-plus"></i> Add Department
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Code</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Head of Department</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="departmentsTable">
                                        <tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Classes Tab -->
                    <div class="tab-pane fade" id="classes">
                        <div class="section">
                            <div class="section-title">
                                <span>Classes</span>
                                <button class="btn-add" onclick="showAddClassModal()">
                                    <i class="fas fa-plus"></i> Add Class
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Class Code</th>
                                            <th>Name</th>
                                            <th>Grade</th>
                                            <th>Department</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="classesTable">
                                        <tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Groups Tab -->
                    <div class="tab-pane fade" id="groups">
                        <div class="section">
                            <div class="section-title">
                                <span>Groups</span>
                                <button class="btn-add" onclick="showAddGroupModal()">
                                    <i class="fas fa-plus"></i> Add Group
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Group Name</th>
                                            <th>Class</th>
                                            <th>Students</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="groupsTable">
                                        <tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Students Tab -->
                    <div class="tab-pane fade" id="students">
                        <div class="section">
                            <div class="section-title">
                                <span>Students</span>
                                <button class="btn-add" onclick="showAddStudentModal()">
                                    <i class="fas fa-plus"></i> Add Student
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Student ID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Username</th>
                                            <th>Department</th>
                                            <th>Class</th>
                                            <th>Group</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTable">
                                        <tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Teachers Tab -->
                    <div class="tab-pane fade" id="teachers">
                        <div class="section">
                            <div class="section-title">
                                <span>Teachers</span>
                                <button class="btn-add" onclick="showAddTeacherModal()">
                                    <i class="fas fa-plus"></i> Add Teacher
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Username</th>
                                            <th>Department</th>
                                            <th>Subjects</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teachersTable">
                                        <tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals Container -->
    <div id="modalsContainer"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentData = { departments: [], classes: [], groups: [], students: [], teachers: [] };
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });
        
        async function loadAllData() {
            await Promise.all([
                loadDepartments(),
                loadClasses(),
                loadGroups(),
                loadStudents(),
                loadTeachers()
            ]);
            createModals(); // Create modals after data loads
        }
        
        // Data loading functions
        async function loadDepartments() {
            try {
                const response = await fetch('/api/departments', { credentials: 'include' });
                currentData.departments = await response.json();
                
                const tbody = document.getElementById('departmentsTable');
                if (currentData.departments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center empty-state"><i class="fas fa-building"></i><br>No departments yet</td></tr>';
                } else {
                    tbody.innerHTML = currentData.departments.map(dept => `
                        <tr>
                            <td>${dept.code}</td>
                            <td><strong>${dept.name}</strong></td>
                            <td>${dept.description || '-'}</td>
                            <td>${dept.headOfDepartmentName || 'Not Assigned'}</td>
                            <td>
                                <button class="btn-sm-action btn-edit" onclick="editDepartment(${dept.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }
        
        async function loadClasses() {
            try {
                const response = await fetch('/api/classes', { credentials: 'include' });
                currentData.classes = await response.json();
                
                const tbody = document.getElementById('classesTable');
                if (currentData.classes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center empty-state"><i class="fas fa-graduation-cap"></i><br>No classes yet</td></tr>';
                } else {
                    tbody.innerHTML = currentData.classes.map(cls => `
                        <tr>
                            <td>${cls.classCode}</td>
                            <td><strong>${cls.className}</strong></td>
                            <td>${cls.gradeName || '-'}</td>
                            <td>${cls.departmentName || '-'}</td>
                            <td>
                                <button class="btn-sm-action btn-edit" onclick="editClass(${cls.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }
        
        async function loadGroups() {
            try {
                const response = await fetch('/api/groups', { credentials: 'include' });
                currentData.groups = await response.json();
                
                const tbody = document.getElementById('groupsTable');
                if (currentData.groups.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center empty-state"><i class="fas fa-users"></i><br>No groups yet</td></tr>';
                } else {
                    tbody.innerHTML = currentData.groups.map(grp => `
                        <tr>
                            <td><strong>${grp.groupName}</strong></td>
                            <td>${grp.className || '-'}</td>
                            <td>${grp.studentCount || 0}</td>
                            <td>
                                <button class="btn-sm-action btn-edit" onclick="editGroup(${grp.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }
        
        async function loadStudents() {
            try {
                const response = await fetch('/api/students', { credentials: 'include' });
                currentData.students = await response.json();
                
                const tbody = document.getElementById('studentsTable');
                if (currentData.students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center empty-state"><i class="fas fa-user-graduate"></i><br>No students yet</td></tr>';
                } else {
                    tbody.innerHTML = currentData.students.map(student => `
                        <tr>
                            <td>${student.studentId}</td>
                            <td><strong>${student.firstName} ${student.lastName}</strong></td>
                            <td>${student.email}</td>
                            <td>${student.username}</td>
                            <td>${student.departmentName || '-'}</td>
                            <td>${student.className || '-'}</td>
                            <td>${student.groupName || '-'}</td>
                            <td>
                                <button class="btn-sm-action btn-edit" onclick="editStudent(${student.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }
        
        async function loadTeachers() {
            try {
                const response = await fetch('/api/teachers', { credentials: 'include' });
                currentData.teachers = await response.json();
                
                const tbody = document.getElementById('teachersTable');
                if (currentData.teachers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center empty-state"><i class="fas fa-chalkboard-teacher"></i><br>No teachers yet</td></tr>';
                } else {
                    tbody.innerHTML = currentData.teachers.map(teacher => `
                        <tr>
                            <td><strong>${teacher.firstName} ${teacher.lastName}</strong></td>
                            <td>${teacher.email}</td>
                            <td>${teacher.username}</td>
                            <td>${teacher.departmentName || '-'}</td>
                            <td>${teacher.subjectNames ? teacher.subjectNames.split(',').length + ' subjects' : '0 subjects'}</td>
                            <td>
                                <button class="btn-sm-action btn-edit" onclick="editTeacher(${teacher.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading teachers:', error);
            }
        }
        
        // Create modals dynamically
        function createModals() {
            const container = document.getElementById('modalsContainer');
            if (!container) return;
            
            // Build teacher options for HOD dropdown
            let teacherOptions = '';
            for (let i = 0; i < currentData.teachers.length; i++) {
                const t = currentData.teachers[i];
                teacherOptions += '<option value="' + t.id + '">' + t.firstName + ' ' + t.lastName + '</option>';
            }
            
            // Build department options
            let deptOptions = '';
            for (let i = 0; i < currentData.departments.length; i++) {
                const d = currentData.departments[i];
                deptOptions += '<option value="' + d.id + '">' + d.name + '</option>';
            }
            
            // Build class options
            let classOptions = '';
            for (let i = 0; i < currentData.classes.length; i++) {
                const c = currentData.classes[i];
                classOptions += '<option value="' + c.id + '">' + c.className + '</option>';
            }
            
            // Build group options
            let groupOptions = '';
            for (let i = 0; i < currentData.groups.length; i++) {
                const g = currentData.groups[i];
                groupOptions += '<option value="' + g.id + '">' + g.groupName + '</option>';
            }
            
            container.innerHTML = `
                <!-- Department Modal -->
                <div class="modal fade" id="departmentModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="departmentModalTitle">Add Department</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="departmentForm" onsubmit="saveDepartment(event)">
                                    <input type="hidden" id="departmentId">
                                    <div class="mb-3">
                                        <label class="form-label">Code</label>
                                        <input type="text" class="form-control" id="deptCode" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Name</label>
                                        <input type="text" class="form-control" id="deptName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="deptDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Head of Department</label>
                                        <select class="form-select" id="deptHodId">
                                            <option value="">Select Teacher (Optional)</option>
                                            ${teacherOptions}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn-add w-100"><i class="fas fa-save"></i> Save</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Class Modal -->
                <div class="modal fade" id="classModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="classModalTitle">Add Class</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="classForm" onsubmit="saveClass(event)">
                                    <input type="hidden" id="classId">
                                    <div class="mb-3">
                                        <label class="form-label">Class Code</label>
                                        <input type="text" class="form-control" id="classCode" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Class Name</label>
                                        <input type="text" class="form-control" id="className" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Department</label>
                                        <select class="form-select" id="classDeptId" required>
                                            <option value="">Select Department</option>
                                            ${deptOptions}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn-add w-100"><i class="fas fa-save"></i> Save</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Group Modal -->
                <div class="modal fade" id="groupModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="groupModalTitle">Add Group</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="groupForm" onsubmit="saveGroup(event)">
                                    <input type="hidden" id="groupId">
                                    <div class="mb-3">
                                        <label class="form-label">Group Name</label>
                                        <input type="text" class="form-control" id="groupName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Class</label>
                                        <select class="form-select" id="groupClassId" required>
                                            <option value="">Select Class</option>
                                            ${classOptions}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn-add w-100"><i class="fas fa-save"></i> Save</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Student Modal -->
                <div class="modal fade" id="studentModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="studentModalTitle">Add Student</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="studentForm" onsubmit="saveStudent(event)">
                                    <input type="hidden" id="studentDbId">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Student ID</label>
                                            <input type="text" class="form-control" id="studentId" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Username</label>
                                            <input type="text" class="form-control" id="studentUsername" required>
                                            <small class="text-muted">Login username</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="studentFirstName" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="studentLastName" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="studentEmail" required>
                                    </div>
                                    <div class="mb-3" id="passwordField">
                                        <label class="form-label">Password</label>
                                        <input type="password" class="form-control" id="studentPassword" required>
                                        <small class="text-muted">Leave blank when editing to keep current password</small>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Department</label>
                                            <select class="form-select" id="studentDeptId" required>
                                                <option value="">Select Department</option>
                                                ${deptOptions}
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Class</label>
                                            <select class="form-select" id="studentClassId" required>
                                                <option value="">Select Class</option>
                                                ${classOptions}
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Group</label>
                                            <select class="form-select" id="studentGroupId">
                                                <option value="">Select Group (Optional)</option>
                                                ${groupOptions}
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn-add w-100"><i class="fas fa-save"></i> Save Student</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teacher Modal -->
                <div class="modal fade" id="teacherModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="teacherModalTitle">Add Teacher</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="teacherForm" onsubmit="saveTeacher(event)">
                                    <input type="hidden" id="teacherDbId">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="teacherFirstName" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="teacherLastName" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="teacherEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Username</label>
                                        <input type="text" class="form-control" id="teacherUsername" required>
                                        <small class="text-muted">Login username</small>
                                    </div>
                                    <div class="mb-3" id="teacherPasswordField">
                                        <label class="form-label">Password</label>
                                        <input type="password" class="form-control" id="teacherPassword" required>
                                        <small class="text-muted">Leave blank when editing to keep current password</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Department</label>
                                        <select class="form-select" id="teacherDeptId" required>
                                            <option value="">Select Department</option>
                                            ${deptOptions}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn-add w-100"><i class="fas fa-save"></i> Save Teacher</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Modal show functions
        function showAddDepartmentModal() {
            document.getElementById('departmentModalTitle').textContent = 'Add Department';
            document.getElementById('departmentForm').reset();
            document.getElementById('departmentId').value = '';
            new bootstrap.Modal(document.getElementById('departmentModal')).show();
        }
        
        function showAddClassModal() {
            document.getElementById('classModalTitle').textContent = 'Add Class';
            document.getElementById('classForm').reset();
            document.getElementById('classId').value = '';
            new bootstrap.Modal(document.getElementById('classModal')).show();
        }
        
        function showAddGroupModal() {
            document.getElementById('groupModalTitle').textContent = 'Add Group';
            document.getElementById('groupForm').reset();
            document.getElementById('groupId').value = '';
            new bootstrap.Modal(document.getElementById('groupModal')).show();
        }
        
        function showAddStudentModal() {
            document.getElementById('studentModalTitle').textContent = 'Add Student';
            document.getElementById('studentForm').reset();
            document.getElementById('studentDbId').value = '';
            document.getElementById('studentPassword').required = true;
            new bootstrap.Modal(document.getElementById('studentModal')).show();
        }
        
        function showAddTeacherModal() {
            document.getElementById('teacherModalTitle').textContent = 'Add Teacher';
            document.getElementById('teacherForm').reset();
            document.getElementById('teacherDbId').value = '';
            document.getElementById('teacherPassword').required = true;
            new bootstrap.Modal(document.getElementById('teacherModal')).show();
        }
        
        // Edit functions
        async function editDepartment(id) {
            const dept = currentData.departments.find(d => d.id === id);
            if (!dept) return;
            
            document.getElementById('departmentModalTitle').textContent = 'Edit Department';
            document.getElementById('departmentId').value = dept.id;
            document.getElementById('deptCode').value = dept.code;
            document.getElementById('deptName').value = dept.name;
            document.getElementById('deptDescription').value = dept.description || '';
            document.getElementById('deptHodId').value = dept.headOfDepartmentId || '';
            
            new bootstrap.Modal(document.getElementById('departmentModal')).show();
        }
        
        async function editClass(id) {
            const cls = currentData.classes.find(c => c.id === id);
            if (!cls) return;
            
            document.getElementById('classModalTitle').textContent = 'Edit Class';
            document.getElementById('classId').value = cls.id;
            document.getElementById('classCode').value = cls.classCode;
            document.getElementById('className').value = cls.className;
            document.getElementById('classDeptId').value = cls.departmentId || '';
            
            new bootstrap.Modal(document.getElementById('classModal')).show();
        }
        
        async function editGroup(id) {
            const grp = currentData.groups.find(g => g.id === id);
            if (!grp) return;
            
            document.getElementById('groupModalTitle').textContent = 'Edit Group';
            document.getElementById('groupId').value = grp.id;
            document.getElementById('groupName').value = grp.groupName;
            document.getElementById('groupClassId').value = grp.classId || '';
            
            new bootstrap.Modal(document.getElementById('groupModal')).show();
        }
        
        async function editStudent(id) {
            const student = currentData.students.find(s => s.id === id);
            if (!student) return;
            
            document.getElementById('studentModalTitle').textContent = 'Edit Student';
            document.getElementById('studentDbId').value = student.id;
            document.getElementById('studentId').value = student.studentId;
            document.getElementById('studentUsername').value = student.username;
            document.getElementById('studentFirstName').value = student.firstName;
            document.getElementById('studentLastName').value = student.lastName;
            document.getElementById('studentEmail').value = student.email;
            document.getElementById('studentPassword').value = '';
            document.getElementById('studentPassword').required = false;
            document.getElementById('studentDeptId').value = student.departmentId || '';
            document.getElementById('studentClassId').value = student.classId || '';
            document.getElementById('studentGroupId').value = student.groupId || '';
            
            new bootstrap.Modal(document.getElementById('studentModal')).show();
        }
        
        async function editTeacher(id) {
            const teacher = currentData.teachers.find(t => t.id === id);
            if (!teacher) return;
            
            document.getElementById('teacherModalTitle').textContent = 'Edit Teacher';
            document.getElementById('teacherDbId').value = teacher.id;
            document.getElementById('teacherFirstName').value = teacher.firstName;
            document.getElementById('teacherLastName').value = teacher.lastName;
            document.getElementById('teacherEmail').value = teacher.email;
            document.getElementById('teacherUsername').value = teacher.username;
            document.getElementById('teacherPassword').value = '';
            document.getElementById('teacherPassword').required = false;
            document.getElementById('teacherDeptId').value = teacher.departmentId || '';
            
            new bootstrap.Modal(document.getElementById('teacherModal')).show();
        }
        
        // Save functions
        async function saveDepartment(event) {
            event.preventDefault();
            
            const id = document.getElementById('departmentId').value;
            const data = {
                code: document.getElementById('deptCode').value,
                name: document.getElementById('deptName').value,
                description: document.getElementById('deptDescription').value,
                headOfDepartmentId: document.getElementById('deptHodId').value || null
            };
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/departments/${id}` : '/api/departments';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('departmentModal')).hide();
                    await loadDepartments();
                    createModals();
                } else {
                    const error = await response.text();
                    alert('Failed to save department: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function saveClass(event) {
            event.preventDefault();
            
            const id = document.getElementById('classId').value;
            const data = {
                classCode: document.getElementById('classCode').value,
                className: document.getElementById('className').value,
                departmentId: document.getElementById('classDeptId').value
            };
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/classes/${id}` : '/api/classes';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('classModal')).hide();
                    await loadClasses();
                    createModals();
                } else {
                    const error = await response.text();
                    alert('Failed to save class: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function saveGroup(event) {
            event.preventDefault();
            
            const id = document.getElementById('groupId').value;
            const data = {
                groupName: document.getElementById('groupName').value,
                classId: document.getElementById('groupClassId').value
            };
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/groups/${id}` : '/api/groups';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('groupModal')).hide();
                    await loadGroups();
                    createModals();
                } else {
                    const error = await response.text();
                    alert('Failed to save group: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function saveStudent(event) {
            event.preventDefault();
            
            const id = document.getElementById('studentDbId').value;
            const data = {
                studentId: document.getElementById('studentId').value,
                username: document.getElementById('studentUsername').value,
                firstName: document.getElementById('studentFirstName').value,
                lastName: document.getElementById('studentLastName').value,
                email: document.getElementById('studentEmail').value,
                departmentId: document.getElementById('studentDeptId').value,
                classId: document.getElementById('studentClassId').value,
                groupId: document.getElementById('studentGroupId').value || null
            };
            
            // Add password only if provided (for new or if changing)
            const password = document.getElementById('studentPassword').value;
            if (password) {
                data.password = password;
            }
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/students/${id}` : '/api/students';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
                    await loadStudents();
                } else {
                    const error = await response.text();
                    alert('Failed to save student: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function saveTeacher(event) {
            event.preventDefault();
            
            const id = document.getElementById('teacherDbId').value;
            const data = {
                firstName: document.getElementById('teacherFirstName').value,
                lastName: document.getElementById('teacherLastName').value,
                email: document.getElementById('teacherEmail').value,
                username: document.getElementById('teacherUsername').value,
                departmentId: document.getElementById('teacherDeptId').value
            };
            
            // Add password only if provided (for new or if changing)
            const password = document.getElementById('teacherPassword').value;
            if (password) {
                data.password = password;
            }
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/teachers/${id}` : '/api/teachers';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('teacherModal')).hide();
                    await loadTeachers();
                    createModals();
                } else {
                    const error = await response.text();
                    alert('Failed to save teacher: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>
